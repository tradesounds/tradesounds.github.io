<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Invoice Otomatis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container my-4">
      <h3 class="text-center mb-4">Invoice Otomatis</h3>
      <div class="card shadow p-4">
        <div class="mb-3 d-flex justify-content-between">
          <button id="addRow" class="btn btn-success">Tambah Produk</button>
          <button id="clearAll" class="btn btn-danger">Clear Semua Data</button>
        </div>

        <table class="table table-bordered" id="invoiceTable">
          <thead class="table-light">
            <tr>
              <th>Deskripsi Produk</th>
              <th>Qty</th>
              <th>Harga</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="text-end fw-bold mt-3">
          Grand Total: Rp <span id="grandTotal">0</span>
        </div>
      </div>
    </div>

    <script>
      let autoSaveInterval;

      function calculateRow(row) {
        const qty = parseFloat(row.querySelector(".qty").value) || 0;
        const price = parseFloat(row.querySelector(".price").value) || 0;
        const total = qty * price;
        row.querySelector(".total").textContent = total.toLocaleString("id-ID");
        return total;
      }

      function updateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll("#invoiceTable tbody tr").forEach(row => {
          grandTotal += calculateRow(row);
        });
        document.getElementById("grandTotal").textContent = grandTotal.toLocaleString("id-ID");
      }

      function saveData() {
        const data = [];
        document.querySelectorAll("#invoiceTable tbody tr").forEach(row => {
          const desc = row.querySelector(".desc").value;
          const qty = row.querySelector(".qty").value;
          const price = row.querySelector(".price").value;
          data.push({ desc, qty, price });
        });
        localStorage.setItem("invoiceData", JSON.stringify(data));
      }

      function loadData() {
        const saved = localStorage.getItem("invoiceData");
        if (saved) {
          const data = JSON.parse(saved);
          data.forEach(item => appendRow(item));
        }
      }

      function appendRow(item = { desc: "", qty: 1, price: 0 }) {
        const tbody = document.querySelector("#invoiceTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" class="form-control desc" value="${item.desc}"></td>
          <td><input type="number" class="form-control qty" value="${item.qty}"></td>
          <td><input type="number" class="form-control price" value="${item.price}"></td>
          <td>Rp <span class="total">0</span></td>
          <td><button class="btn btn-danger btn-sm deleteRow">Hapus</button></td>
        `;
        tbody.appendChild(tr);
        calculateRow(tr);
        updateGrandTotal();
      }

      function clearData() {
        clearInterval(autoSaveInterval); // hentikan auto-save sementara
        localStorage.removeItem("invoiceData"); // hapus dari localStorage
        document.querySelector("#invoiceTable tbody").innerHTML = ""; // kosongkan tabel
        document.getElementById("grandTotal").textContent = "0"; // reset total
        alert("Semua data telah dihapus!");
        startAutoSave(); // nyalakan kembali auto-save setelah clear
      }

      function startAutoSave() {
        // pastikan tidak ada interval ganda
        clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(() => {
          saveData();
        }, 5000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadData();

        if (document.querySelectorAll("#invoiceTable tbody tr").length === 0) {
          appendRow();
          saveData();
        }

        document.getElementById("addRow").addEventListener("click", () => {
          appendRow();
          saveData();
        });

        document.getElementById("clearAll").addEventListener("click", () => {
          clearData();
        });

        document.querySelector("#invoiceTable tbody").addEventListener("input", e => {
          if (e.target.classList.contains("qty") || e.target.classList.contains("price")) {
            calculateRow(e.target.closest("tr"));
            updateGrandTotal();
            saveData();
          }
        });

        document.querySelector("#invoiceTable tbody").addEventListener("click", e => {
          if (e.target.classList.contains("deleteRow")) {
            e.target.closest("tr").remove();
            updateGrandTotal();
            saveData();
          }
        });

        startAutoSave();
      });
    </script>
  </body>
</html>
